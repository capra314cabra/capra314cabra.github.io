<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="capra314cabra"><meta name=description content="I encountered the situaton that CreateGlobalStringPtr failed in the block of if statement, so I will introduce the way to solve it."><meta name=keywords content="CreateGlobalStringPtr,LLVM,crash,failed,error"><meta name=twitter:card content="summary"><meta name=twitter:title content="[LLVM] How to solve CreateGlobalStringPtr crash"><meta name=twitter:description content="I encountered the situaton that CreateGlobalStringPtr failed in the block of if statement, so I will introduce the way to solve it."><meta property="og:title" content="[LLVM] How to solve CreateGlobalStringPtr crash"><meta property="og:description" content="I encountered the situaton that CreateGlobalStringPtr failed in the block of if statement, so I will introduce the way to solve it."><meta property="og:type" content="article"><meta property="og:url" content="https://capra314cabra.github.io/en/posts/2020-05-02-llvm-string-ptr/"><meta property="article:published_time" content="2020-05-02T07:51:32+09:00"><meta property="article:modified_time" content="2020-05-02T08:31:06+09:00"><base href=https://capra314cabra.github.io/en/posts/2020-05-02-llvm-string-ptr/><title>[LLVM] How to solve CreateGlobalStringPtr crash · Capra Cabra Notes</title><link rel=canonical href=https://capra314cabra.github.io/en/posts/2020-05-02-llvm-string-ptr/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js onload=hljs.initHighlightingOnLoad(); async></script><link rel=stylesheet href=https://capra314cabra.github.io/css/coder.min.0f28f86059ff6e679f9cf08b95a190db2c1071167c8abc38584f0eef978c93f7.css integrity="sha256-Dyj4YFn/bmefnPCLlaGQ2ywQcRZ8irw4WE8O75eMk/c=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/vs2015.min.css><script src=https://cdn.jsdelivr.net/npm/gist-embed@1.0.3/dist/gist-embed.min.js async></script><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js async></script><link rel=icon type=image/png href=https://capra314cabra.github.io/images/logo/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://capra314cabra.github.io/images/logo/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.75.1"><style type=text/css>.icon{font-size:2.5em}</style></head><body class=colorscheme-light><script type=text/javascript src="https://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e930c5ad359121c" async></script><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://capra314cabra.github.io/en>Capra Cabra Notes</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars"></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://capra314cabra.github.io/en/>About</a></li><li class=navigation-item><a class=navigation-link href=https://capra314cabra.github.io/en/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://capra314cabra.github.io/en/games/>Games</a></li><li class=navigation-item><a class=navigation-link href=https://capra314cabra.github.io/en/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://github.com/capra314cabra>GitHub</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://capra314cabra.github.io/>日本語</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>[LLVM] How to solve CreateGlobalStringPtr crash</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i><time datetime=2020-05-02T07:51:32+09:00>May 2, 2020</time></span>
<span class=reading-time><i class="fas fa-clock"></i>2-minute read</span></div><div class=tags><i class="fas fa-tag"></i><a href=https://capra314cabra.github.io/en/tags/llvm/>LLVM</a>
<span class=separator>•</span>
<a href=https://capra314cabra.github.io/en/tags/cplusplus/>CPlusPlus</a></div></div></header><div><p>I encountered the situaton that CreateGlobalStringPtr failed in the block of if statement, so I will introduce the way to solve it. (Also I found it had been my fault, but you can be.)</p><h2 id=the-error-that-occurred>The error that occurred</h2><p>First, let&rsquo;s implement if statements frankly.</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=color:#fff;font-weight:700>auto</span> ifblock = llvm::BasicBlock::Create(module-&gt;getContext(), <span style=color:#0ff;font-weight:700>&#34;then&#34;</span>);

<span style=color:#fff;font-weight:700>auto</span> mergeblock = llvm::BasicBlock::Create(module-&gt;getContext(), <span style=color:#0ff;font-weight:700>&#34;merged&#34;</span>);
</code></pre></div><p>This is the part where we declare two Basic Blocks, one will be the inside of the if statement and the other will be the bottom of the end of the if statement.</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++>builder-&gt;CreateCondBr(match, ifblock, mergeblock);

builder-&gt;SetInsertPoint(ifblock);

<span style=color:#fff;font-weight:700>auto</span> strptr = builder-&gt;CreateGlobalStringPtr(<span style=color:#0ff;font-weight:700>&#34;Hello World&#34;</span>); <span style=color:#007f7f>// ERROR !
</span><span style=color:#007f7f></span>
builder-&gt;CreateBr(mergeblock);
</code></pre></div><p>If it behaves as we expected, it will create a branch, do <code>SetInsertPoint</code> to the block named &ldquo;then&rdquo;, allocate the character string" Hello World" in the global space and get its pointer.</p><p>Assuming that you have done this operation in a function, it should be almost equivalent to the code below.</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=color:#fff;font-weight:700>const</span> <span style=color:#fff;font-weight:700>char</span>* str = <span style=color:#0ff;font-weight:700>&#34;Hello World&#34;</span>;

<span style=color:#fff;font-weight:700>void</span> somefunc() {
    <span style=color:#fff;font-weight:700>bool</span> match;

    <span style=color:#fff;font-weight:700>if</span> (match) {
        <span style=color:#007f7f>// Create global string poiter and it points &#34;HelloWorld&#34;.
</span><span style=color:#007f7f></span>        <span style=color:#fff;font-weight:700>auto</span> strptr = str;
    }
}
</code></pre></div><p>But this code fails. Why.</p><h2 id=pay-attention-to-the-parent-function-of-basicblock>Pay attention to the parent function of BasicBlock!</h2><p>You may have realized. (I&rsquo;m not bright at all so it took me two hours to solve it&mldr;)
The parent functions of <code>ifblock</code> and <code>mergeblock</code> are not specified. The function, <code>BasicBlock::Create</code> can be used without specifying the parent function, so I wasn&rsquo;t noticed.</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++>BasicBlock::Create(LLVMContext &amp;Context, <span style=color:#fff;font-weight:700>const</span> Twine &amp;Name=<span style=color:#0ff;font-weight:700>&#34;&#34;</span>, Function *Parent=<span style=color:#fff;font-weight:700>nullptr</span>, BasicBlock *InsertBefore=<span style=color:#fff;font-weight:700>nullptr</span>);
</code></pre></div><p><a href=https://llvm.org/doxygen/classllvm_1_1BasicBlock.html>llvm::BasicBlock Class Reference</a></p><p>Some operations can be performed without specifying the parent function, but calling <code>CreateGlobalStringPtr</code> requires the parent function and BasicBlock.</p><p>In summary, it means that you cannot call <code>CreateGlobalStringPtr</code> without specifying the parent function.</p><h2 id=tips-get-the-currently-inserted-function>[Tips] Get the currently inserted function</h2><p>It can be done by getting the current BasicBlock and then its parent function.</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=color:#fff;font-weight:700>auto</span> parent = builder-&gt;GetInsertBlock()-&gt;getParent();
</code></pre></div><p>Now, we found that just rewriting like this fix the error.</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=color:#fff;font-weight:700>auto</span> ifblock = llvm::BasicBlock::Create(module-&gt;getContext(), <span style=color:#0ff;font-weight:700>&#34;then&#34;</span>, parent);

<span style=color:#fff;font-weight:700>auto</span> mergeblock = llvm::BasicBlock::Create(module-&gt;getContext(), <span style=color:#0ff;font-weight:700>&#34;merged&#34;</span>, parent);
</code></pre></div></div><footer><script src=https://utteranc.es/client.js repo=capra314cabra/capra314cabra.github.io issue-term=title label=comments theme=github-light crossorigin=anonymous async></script></footer></article></section></div><footer class=footer><section class=container><p>Wanna be a developer improving our lives.</p>© 2020
<a href=https://github.com/capra314cabra>capra314cabra</a></section></footer></main></body></html>