<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="capra314cabra"><meta name=description content="LLVMのC++ APIを使用し、printfを呼び出してfloat型の変数を表示するLLVM IRを出力するまで行います。"><meta name=keywords content="llvm,printf,float,ir,c++"><meta name=twitter:card content="summary"><meta name=twitter:title content="[LLVM] printfでFloat型の足し算の結果を表示する"><meta name=twitter:description content="LLVMのC++ APIを使用し、printfを呼び出してfloat型の変数を表示するLLVM IRを出力するまで行います。"><meta property="og:title" content="[LLVM] printfでFloat型の足し算の結果を表示する"><meta property="og:description" content="LLVMのC++ APIを使用し、printfを呼び出してfloat型の変数を表示するLLVM IRを出力するまで行います。"><meta property="og:type" content="article"><meta property="og:url" content="https://capra314cabra.github.io/posts/2020-04-09-llvm-printf-float/"><meta property="article:published_time" content="2020-04-09T13:06:28+09:00"><meta property="article:modified_time" content="2020-04-09T16:58:58+09:00"><meta property="og:site_name" content="Capra Cabra Notes"><base href=https://capra314cabra.github.io/posts/2020-04-09-llvm-printf-float/><title>[LLVM] printfでFloat型の足し算の結果を表示する · Capra Cabra Notes</title><link rel=canonical href=https://capra314cabra.github.io/posts/2020-04-09-llvm-printf-float/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js onload=hljs.initHighlightingOnLoad(); async></script><link rel=stylesheet href=https://capra314cabra.github.io/css/coder.min.0f28f86059ff6e679f9cf08b95a190db2c1071167c8abc38584f0eef978c93f7.css integrity="sha256-Dyj4YFn/bmefnPCLlaGQ2ywQcRZ8irw4WE8O75eMk/c=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/vs2015.min.css><script src=https://cdn.jsdelivr.net/npm/gist-embed@1.0.3/dist/gist-embed.min.js async></script><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js async></script><link rel=icon type=image/png href=https://capra314cabra.github.io/images/logo/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://capra314cabra.github.io/images/logo/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.75.1"><style type=text/css>.icon{font-size:2.5em}</style></head><body class=colorscheme-light><script type=text/javascript src="https://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e930c5ad359121c" async></script><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://capra314cabra.github.io/>Capra Cabra Notes</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars"></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://capra314cabra.github.io/>About</a></li><li class=navigation-item><a class=navigation-link href=https://capra314cabra.github.io/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://capra314cabra.github.io/games/>Games</a></li><li class=navigation-item><a class=navigation-link href=https://capra314cabra.github.io/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://github.com/capra314cabra>GitHub</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://capra314cabra.github.io/en/>English</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>[LLVM] printfでFloat型の足し算の結果を表示する</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i><time datetime=2020-04-09T13:06:28+09:00>April 9, 2020</time></span>
<span class=reading-time><i class="fas fa-clock"></i>2分で読めます</span></div><div class=tags><i class="fas fa-tag"></i><a href=https://capra314cabra.github.io/tags/cplusplus/>CPlusPlus</a>
<span class=separator>•</span>
<a href=https://capra314cabra.github.io/tags/llvm/>LLVM</a></div></div></header><div><p>LLVMのC++ APIを使用して、printfでFloat同士の足し算の結果を表示するLLVM IRを表示するまでを行いたいと思います。</p><h2 id=筆者の環境>筆者の環境</h2><ul><li>LLVM: LLVM 9.0.1</li><li>Compiler: Visual Studio付属のcl.exe</li></ul><h2 id=こんなコードを出力したい>こんなコードを出力したい</h2><p>以下のC言語のプログラムと同じ動きをするLLVM IRを出力するのが今回の目標です。<br>floatの値を2つ足し算をしてprintfですね。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#0f0;font-weight:700>#include</span> <span style=color:#0f0;font-weight:700>&lt;stdio.h&gt;</span><span style=color:#0f0;font-weight:700>
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>int</span> main() {
    <span style=color:#fff;font-weight:700>float</span> f1 = <span style=color:#ff0;font-weight:700>3.5</span>;
    <span style=color:#fff;font-weight:700>float</span> f2 = <span style=color:#ff0;font-weight:700>6.4</span>;
    printf(<span style=color:#0ff;font-weight:700>&#34;%f + %f = %f</span><span style=color:#0ff;font-weight:700>\n</span><span style=color:#0ff;font-weight:700>&#34;</span>, f1, f2, f1 + f2);
    <span style=color:#fff;font-weight:700>return</span> <span style=color:#ff0;font-weight:700>0</span>;
}
</code></pre></div><h2 id=まずはprintfを定義しよう>まずはprintfを定義しよう</h2><p>まず、printfの定義について思い出してみましょう。<br>printfは関数の引数として、フォーマットの文字列と、複数の値をとることができます。<br>戻り値はInt32型で帰ってきます。(私は戻り値を使ったことがあまりないです。)</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#fff;font-weight:700>int</span> printf(<span style=color:#fff;font-weight:700>const</span> <span style=color:#fff;font-weight:700>char</span>* format, ...);
</code></pre></div><p>それではC++のコードで実装していきます。<br>まず、LLVMのサポートClassを初期化していきましょう。<br>Builderが大文字なのは、LLVMの公式Tutorialで大文字になっていたので、それに慣れてしまったからです。変数名は勿論変えていただいて問題ありません。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++>llvm::LLVMContext context;
llvm::IRBuilder&lt;&gt; Builder(context);
llvm::Module* module;

module = <span style=color:#fff;font-weight:700>new</span> llvm::Module(<span style=color:#0ff;font-weight:700>&#34;test.ll&#34;</span>, context);
</code></pre></div><p>これからいちいち型を定義するのは大変なので、基本的な型はマクロとして簡単にかける様にしておきます。これは本当に我流なのでこのマクロを定義するのが一般的だと思い込まないでください&mldr;</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=color:#0f0;font-weight:700>#define LLVM_INT8_PTR_TY llvm::Type::getInt8PtrTy(context)
</span><span style=color:#0f0;font-weight:700>#define LLVM_INT32_TY llvm::Type::getInt32Ty(context)
</span><span style=color:#0f0;font-weight:700>#define LLVM_FLOAT_TY llvm::Type::getFloatTy(context)
</span><span style=color:#0f0;font-weight:700>#define LLVM_DOUBLE_TY llvm::Type::getDoubleTy(context)
</span></code></pre></div><p>これで前準備は終了です。printfの定義に移っていきましょう。<br>まずは関数の"型"を定義します。戻り値の型とvectorに詰めた引数の型を<code>llvm::FunctionType::get</code>に投げて、関数の型を受け取ります。<br>Int8型(Char型)のポインターを引数にして、戻り値をInt32型で返します。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++>std::vector&lt;llvm::Type*&gt; printfFuncArgs;
printfFuncArgs.push_back(LLVM_INT8_PTR_TY);

<span style=color:#fff;font-weight:700>auto</span> printfFuncType = llvm::FunctionType::get(
    LLVM_INT32_TY,
    printfFuncArgs,
    <span style=color:#fff;font-weight:700>true</span>
);
</code></pre></div><p>続けてprintf本体を作成しましょう。以下のようになります。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=color:#fff;font-weight:700>auto</span> printfFunc = llvm::Function::Create(
    printfFuncType,
    llvm::GlobalValue::ExternalLinkage,
    <span style=color:#0ff;font-weight:700>&#34;printf&#34;</span>,
    module);

printfFunc-&gt;setCallingConv(llvm::CallingConv::C);
</code></pre></div><h2 id=main関数を定義しよう省略気味>main関数を定義しよう(省略気味)</h2><p>ここは本質ではないのでコードを書きます。<br>コピペするか、コードの内容を察してください。<br>基本、printfの時と同じなので比べるとわかりやすいかもしれません。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++>std::vector&lt;llvm::Type*&gt; mainFuncArgs;

<span style=color:#fff;font-weight:700>auto</span> mainFuncType = llvm::FunctionType::get(
    LLVM_INT32_TY,
    mainFuncArgs,
    <span style=color:#fff;font-weight:700>false</span>
);

<span style=color:#fff;font-weight:700>auto</span> mainFunc = llvm::Function::Create(
    mainFuncType,
    llvm::GlobalValue::ExternalLinkage,
    <span style=color:#0ff;font-weight:700>&#34;main&#34;</span>,
    module);

mainFunc-&gt;setCallingConv(llvm::CallingConv::C);
</code></pre></div><h2 id=main関数の中へ省略気味>main関数の中へ(省略気味)</h2><p>main関数の中に命令を並べる準備をしましょう。これも本質ではないので省略気味です。<br>これ以降、<code>Builder.CreateSomething</code>みたいな関数を呼ぶと、main関数内に挿入されるようになります。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=color:#fff;font-weight:700>auto</span> mainBlock = llvm::BasicBlock::Create(
    context,
    <span style=color:#0ff;font-weight:700>&#34;entry&#34;</span>,
    mainFunc
);
Builder.SetInsertPoint(mainBlock);
</code></pre></div><h2 id=floatで足し算をしよう>floatで足し算をしよう</h2><p>やっと本題です。まずは、足し算に使用する値を用意しましょう。</p><p>1行目ではFloatのサイズだけメモリをAllocateしています。この時の戻り値が表現している型はポインターなので注意です。<br>2行目では値を初期化しています。定数値を定義してStoreするという形で実現します。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=color:#fff;font-weight:700>auto</span> f1PtrVal = Builder.CreateAlloca(
    LLVM_FLOAT_TY,
    llvm::ConstantInt::get(LLVM_INT32_TY, <span style=color:#ff0;font-weight:700>1</span>)
);

Builder.CreateStore(
    llvm::ConstantFP::get(LLVM_FLOAT_TY, <span style=color:#ff0;font-weight:700>3.5</span>),
    f1PtrVal
);
</code></pre></div><p>f1と同じようにf2を定義したものとします。(f1, f2って何ぞや、とおもった人は上にある目標のC言語コードを読んでください。)<br>足し算はポインター同士ではできないので、二つの値をLoadしてあげてFAdd命令で実現します。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=color:#fff;font-weight:700>auto</span> f1Val = Builder.CreateLoad(f1PtrVal);
<span style=color:#fff;font-weight:700>auto</span> f2Val = Builder.CreateLoad(f2PtrVal);
<span style=color:#fff;font-weight:700>auto</span> calcVal = Builder.CreateFAdd(f1Val1, f2Val2);
</code></pre></div><h2 id=printfをいよいよ呼び出そう-しかし>printfをいよいよ呼び出そう しかし&mldr;</h2><p>まずformatの文字列を定義します。Constantな文字列でやっていくので、<code>CreateGlobalStringPtr</code>に投げます。戻り値は、Int8型のポインターを表現したものです。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=color:#fff;font-weight:700>auto</span> formatVal = Builder.CreateGlobalStringPtr(<span style=color:#0ff;font-weight:700>&#34;%f + %f = %f&#34;</span>);
</code></pre></div><p>皆さんお待ちかね、遂にprintfを呼び出します。<br>printfを呼び出す命令に引数たちをvectorに詰めたものを渡します。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++>std::vector&lt;llvm::Value*&gt; args;
args.push_back(formatVal);
args.push_back(f1Val);
args.push_back(f2Val);
args.push_back(calcVal);

Builder.CreateCall(printfFunc, args);
</code></pre></div><p>main関数に対するRet命令を加えましょう。Int32の0を戻り値として返しています。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++>Builder.CreateRet(llvm::Constant::getNullValue(LLVM_INT32_TY));
</code></pre></div><p>これまでに定義した命令たちをLLVM IRとして書き込んで出力しましょう。<br>この出力方法なんですが、それっぽい名前の関数をドキュメントから探して動かしてみたら動いた、というものなので、正しい方法を知っている方、ぜひコメントで教えてください。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++>llvm::verifyModule(*module);

std::error_code errorcode;
<span style=color:#fff;font-weight:700>auto</span> stream = <span style=color:#fff;font-weight:700>new</span> llvm::raw_fd_ostream(<span style=color:#0ff;font-weight:700>&#34;test.ll&#34;</span>, errorcode);

module-&gt;print(*stream, <span style=color:#fff;font-weight:700>nullptr</span>);
</code></pre></div><h2 id=実行すると>実行すると&mldr;</h2><p>このC++のコードを実行すると、同じディレクトリ内に<code>test.ll</code>というLLVM IRのファイルができているはずです。<br>続けてLLVM IRのファイルを実行してみましょう。<code>lli</code>を使用します。</p><p><code>lli</code>がインストールされていない方は、以下を参考にしてください。</p><p><a href=https://capra314cabra.github.io/posts/llvm-lli-install/>LLVMをWindowsで使いたくて入れたらlliなかった話</a></p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ lli test.ll
0.000000 + 0.000000 = 0.000000
</code></pre></div><p>実行結果はこんな感じになったと思います。<br>なんということでしょう。出力の値が0になってしまいました。</p><h2 id=なぜ0になってしまったのか>なぜ0になってしまったのか</h2><p>この理由は実は私も最初全く分かりませんでした。<br>printfに原因があるのではないか、と思い、調べてみると気になる記事を見つけました。</p><p><a href=https://qiita.com/lo48576/items/9901f7d52692567b931c>Qitta - printf() に float/double を渡したときの挙動と %lf の意義 @lo48576</a></p><p>printfにおける<code>%f</code>は実はdouble型を出力するもので、float型を投げるとdouble型にCastされるようです。<br>LLVM IRによってこのCastが行われずに、Float型がDouble型として読まれて0になってしまった、という仮説が頭に浮かびます。(結果的に正しかったみたいです。)</p><h2 id=表示する前にdouble型にcastする>表示する前にDouble型にCastする</h2><p>自動でDouble型にしてくれないのであれば、自分でDouble型にしたいと思います。<br>FPExt命令を利用しましょう。これを使うと、浮動小数点数の型をより大きいものへ変更できます。(厳密にはCastではない気がしますが&mldr;)</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=color:#fff;font-weight:700>auto</span> f1DoubleVal = Builder.CreateFPExt(f1Val, LLVM_DOUBLE_TY)
</code></pre></div><p>後は、先ほどのprintfを呼び出した部分の値を以下のように置き換えます。</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++>std::vector&lt;llvm::Value*&gt; args;
args.push_back(formatVal);
args.push_back(f1DoubleVal);
args.push_back(f2DoubleVal);
args.push_back(calcDoubleVal);

Builder.CreateCall(printfFunc, args);
</code></pre></div><p>この変更を加えた後、実行してLLVM IRのファイルを入手し、それを実行すると&mldr;</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ lli test.ll
3.500000 + 6.400000 = 9.900000
</code></pre></div><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#0f0;font-weight:700>#include</span> <span style=color:#0f0;font-weight:700>&lt;stdio.h&gt;</span><span style=color:#0f0;font-weight:700>
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>int</span> main() {
    <span style=color:#fff;font-weight:700>float</span> f1 = <span style=color:#ff0;font-weight:700>3.5</span>;
    <span style=color:#fff;font-weight:700>float</span> f2 = <span style=color:#ff0;font-weight:700>6.4</span>;
    printf(<span style=color:#0ff;font-weight:700>&#34;%f + %f = %f</span><span style=color:#0ff;font-weight:700>\n</span><span style=color:#0ff;font-weight:700>&#34;</span>, f1, f2, f1 + f2);
    <span style=color:#fff;font-weight:700>return</span> <span style=color:#ff0;font-weight:700>0</span>;
}
</code></pre></div><p>遂に目標のC言語のコードと同じ出力を得ました。</p><p>ソースコード全文と出力されたLLVM IRは以下から見ることができます。</p><p><a href=https://gist.github.com/capra314cabra/9cd38e8658bb2d07cb9306b73435fada>コード全文</a></p><h2 id=まとめ>まとめ</h2><p>printfでFloat型を表示したいときはDouble型にCastしてからにしましょう。</p></div><footer><script src=https://utteranc.es/client.js repo=capra314cabra/capra314cabra.github.io issue-term=title label=comments theme=github-light crossorigin=anonymous async></script></footer></article></section></div><footer class=footer><section class=container><p>Wanna be a developer improving our lives.</p>© 2020
<a href=https://github.com/capra314cabra>capra314cabra</a></section></footer></main></body></html>